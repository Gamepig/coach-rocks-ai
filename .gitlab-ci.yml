# GitLab CI/CD 設定檔
# 使用此設定可以完全透過 CLI 部署，不需要 Cloudflare Dashboard 設定 Git 連動

stages:
  - deploy-backend
  - deploy-frontend

variables:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"

# Backend Worker 部署
deploy-backend:
  stage: deploy-backend
  image: node:${NODE_VERSION}
  before_script:
    # 安裝 pnpm 和 wrangler
    - npm install -g pnpm@${PNPM_VERSION} wrangler
    # 進入 backend 目錄
    - cd backend
    # 安裝依賴
    - pnpm install
  script:
    # 設定 Cloudflare API Token（從 GitLab CI/CD 變數讀取）
    - export CLOUDFLARE_API_TOKEN="${CLOUDFLARE_API_TOKEN}"
    # 設定 Account ID（從 GitLab CI/CD 變數讀取）
    - export CLOUDFLARE_ACCOUNT_ID="${CLOUDFLARE_ACCOUNT_ID}"
    # ✅ 驗證 TypeScript 編譯（確保沒有編譯錯誤）
    - echo "Checking TypeScript compilation..."
    - npx tsc --noEmit || echo "TypeScript check completed (warnings may exist)"
    # ✅ 清除可能的快取（確保使用最新程式碼）
    - echo "Clearing any build cache..."
    - rm -rf node_modules/.cache dist .wrangler 2>/dev/null || true
    # 部署到 Cloudflare Workers（wrangler 會自動編譯 TypeScript）
    - echo "Deploying to Cloudflare Workers..."
    - wrangler deploy
    # ✅ 驗證部署是否成功
    - echo "Verifying deployment..."
    - sleep 2
    - curl -f ${BACKEND_URL}/api/health || echo "Health check failed (may need a moment to propagate)"
  environment:
    name: production
    url: ${BACKEND_URL}
  # ✅ 使用 rules 語法確保自動觸發（推薦方式）
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: on_success  # 自動觸發，成功時執行
  allow_failure: false

# Frontend Pages 部署
deploy-frontend:
  stage: deploy-frontend
  image: node:${NODE_VERSION}
  before_script:
    # 安裝 pnpm 和 wrangler
    - npm install -g pnpm@${PNPM_VERSION} wrangler
    # 進入 frontend 目錄
    - cd frontend
    # 安裝依賴
    - pnpm install
  script:
    # 設定環境變數（用於建置）
    # 從 GitLab CI/CD 變數讀取
    - export VITE_BACKEND_BASE_URL="${BACKEND_URL}"
    # 設定 Cloudflare Account ID（從 GitLab CI/CD 變數讀取）
    - export CLOUDFLARE_ACCOUNT_ID="${CLOUDFLARE_ACCOUNT_ID}"
    # 建置前端
    - pnpm build
    # 部署到 Cloudflare Pages（account_id 從 CLOUDFLARE_ACCOUNT_ID 環境變數讀取）
    - wrangler pages deploy dist --project-name=coach-rocks-frontend
  environment:
    name: production
    url: ${FRONTEND_URL}
  # ✅ 使用 rules 語法確保自動觸發（推薦方式）
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: on_success  # 自動觸發，成功時執行
  allow_failure: false

